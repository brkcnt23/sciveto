generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATION - Multi-tenant root entity
// ============================================
model Organization {
  id String @id @default(cuid())

  // Identity
  code      String  @unique // ORG-001, ORG-002 (sequential)
  name      String  @unique // Company display name
  legalName String? // Official legal name
  taxId     String? @unique // Tax identification number
  subdomain String  @unique
  domain    String?

  // Subscription & Limits
  plan        SubscriptionPlan @default(BASIC)
  maxUsers    Int              @default(10)
  maxProjects Int              @default(50)

  // Counters (auto-managed)
  userCount     Int @default(1) // Starts at 1 (owner)
  projectCount  Int @default(0)
  employeeCount Int @default(0)

  // Status
  status OrgStatus @default(ACTIVE)

  // Settings
  settings Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  categories Category[]
  stockCategories StockCategory[]
  projects   Project[]
  items      StockItem[]
  users      User[]
  employees  Employee[]
  suppliers  Supplier[]
  purchaseOrders PurchaseOrder[]
}

// ============================================
// ENUMS - Organization related
// ============================================
enum SubscriptionPlan {
  TRIAL
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
}

// ============================================
// USER - System login users (limited per org)
// ============================================
model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String
  firstName String?
  lastName  String?

  // Role & Permissions
  role UserRole @default(ORGANIZATION_OWNER)

  // Profile
  position String? // Job title
  phone    String?
  avatar   String?

  // Status
  isActive    Boolean   @default(true)
  isOnline    Boolean   @default(false)
  lastLoginAt DateTime?

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects           Project[]
  allocations        ProjectAllocation[]
  stockItems         StockItem[]
  createdItems       StockItem[]      @relation("CreatedItems")
  transactions       StockTransaction[]
  projectAssignments ProjectAssignment[]

  @@index([organizationId])
  @@index([role])
  @@index([isActive])
}

// ============================================
// EMPLOYEE - Factory workers (no login, unlimited)
// HR Manager creates these, assigned to projects
// ============================================
model Employee {
  id String @id @default(cuid())

  // Identity
  code      String @unique // EMP-001, EMP-002 (per org sequential)
  firstName String
  lastName  String

  // NO email, NO password - cannot login!

  // Employment
  position        String // "Kaynak Ustası", "Testereci", "Montajcı"
  department      String?
  hireDate        DateTime  @default(now())
  terminationDate DateTime?

  // Payroll
  salary          Decimal?  @db.Decimal(12, 2)
  insuranceStatus Boolean   @default(false)
  insuranceDate   DateTime?

  // Status
  isActive Boolean @default(true)

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projectAssignments ProjectAssignment[]

  @@index([organizationId])
  @@index([code])
  @@index([isActive])
}

model SystemCategoryTemplate {
  id          String             @id @default(cuid())
  name        String
  version     String             @default("1.0")
  isLatest    Boolean            @default(true)
  description String?
  industry    String?
  icon        String?
  changelog   String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  categories  Category[]
  fields      TemplateField[]
  standards   TemplateStandard[]

  @@unique([name, version])
  @@index([name])
  @@index([isLatest])
}

model TemplateStandard {
  id         String                 @id @default(cuid())
  templateId String
  name       String
  value      String
  category   String?
  sortOrder  Int                    @default(0)
  template   SystemCategoryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([category])
}

model TemplateField {
  id           String                 @id @default(cuid())
  templateId   String
  name         String
  label        String
  type         FieldType
  required     Boolean                @default(false)
  defaultValue String?
  options      Json?
  validation   Json?
  unit         String?
  sortOrder    Int                    @default(0)
  template     SystemCategoryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model Category {
  id              String                  @id @default(cuid())
  name            String
  description     String?
  color           String                  @default("#3B82F6")
  icon            String?
  organizationId  String
  templateId      String?
  templateVersion String?
  isSystemBased   Boolean                 @default(false)
  customFields    Json?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template        SystemCategoryTemplate? @relation(fields: [templateId], references: [id])
  stockItems      StockItem[]

  @@unique([name, organizationId])
  @@index([organizationId])
  @@index([templateId])
}

// Stock categories: per-organization category list with icon/color
model StockCategory {
  id              String   @id @default(cuid())
  name            String
  slug            String
  icon            String
  color           String
  description     String?

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  items           StockItem[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model StockItem {
  id              String   @id @default(cuid())

  // Basic Info
  name            String
  code            String?  @unique
  barcode         String?  @unique
  icon            String?
  images          String[] @default([])

  // Category & Classification
  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  stockCategoryId String?
  stockCategory   StockCategory? @relation(fields: [stockCategoryId], references: [id], onDelete: SetNull)

  // Stock Management
  quantity        Decimal  @default(0)
  unit            String   @default("pcs")
  minQuantity     Decimal? @default(10)
  maxQuantity     Decimal? @default(1000)

  // Location
  warehouseLocation String?
  zone              String?

  // Pricing
  purchasePrice     Decimal?
  sellingPrice      Decimal?
  currency          String    @default("TRY")

  // Supplier Info
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  supplierCode      String?
  leadTime          Int?

  // Tracking
  serialNumber      String?
  lotNumber         String?
  expiryDate        DateTime?
  warrantyMonths    Int?

  // Dates
  lastPurchaseDate  DateTime?
  lastUsedDate      DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Technical Specs
  specifications    Json?

  // Status
  isActive          Boolean   @default(true)
  isCritical        Boolean   @default(false)

  // Relations
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById       String?
  createdBy         User?     @relation("CreatedItems", fields: [createdById], references: [id], onDelete: SetNull)

  userId            String?
  user              User?     @relation(fields: [userId], references: [id])

  // Transaction history
  transactions      StockTransaction[]
  projectAllocations ProjectAllocation[]

  @@index([organizationId])
  @@index([categoryId])
  @@index([stockCategoryId])
  @@index([supplierId])
  @@index([code])
  @@index([barcode])
  @@index([warehouseLocation])
}

// New model: Supplier
model Supplier {
  id              String   @id @default(cuid())

  name            String
  code            String   @unique
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  taxId           String?

  rating          Int?     @default(5)
  notes           String?

  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  items           StockItem[]
  purchaseOrders  PurchaseOrder[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
}

// Minimal PurchaseOrder model referenced by Supplier
model PurchaseOrder {
  id             String   @id @default(cuid())
  code           String?
  supplierId     String
  supplier       Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  totalAmount    Decimal? @db.Decimal(14, 2)
  status         String?
  items          Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([supplierId])
}

model StockTransaction {
  id              String   @id @default(cuid())

  type            TransactionType
  quantity        Decimal
  unit            String

  // Reference
  referenceType   String?
  referenceId     String?

  notes           String?

  // Who & When
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  stockItemId     String
  stockItem       StockItem @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  organizationId  String

  createdAt       DateTime @default(now())

  @@index([stockItemId])
  @@index([organizationId])
  @@index([createdAt])
}

model Project {
  id              String              @id @default(cuid())
  code            String? // PRJ-2026-001 (auto-generated)
  name            String
  description     String?
  projectCode     String? // Legacy field - can be deprecated
  clientName      String?
  location        String?
  startDate       DateTime?
  endDate         DateTime?
  estimatedBudget Float?
  actualCost      Float               @default(0)
  organizationId  String
  managerId       String
  status          ProjectStatus       @default(PLANNING)
  priority        ProjectPriority     @default(MEDIUM)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  manager         User                @relation(fields: [managerId], references: [id])
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  allocations     ProjectAllocation[]
  assignments     ProjectAssignment[]

  @@index([organizationId])
  @@index([status])
  @@index([code])
}

// ============================================
// PROJECT ASSIGNMENT - Links Users OR Employees to Projects
// ============================================
model ProjectAssignment {
  id String @id @default(cuid())

  // Project relation
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Can assign either User OR Employee (not both)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Assignment details
  role  String? // "Lead Welder", "Assistant", "Supervisor"
  notes String?

  // Timestamps
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?

  @@index([projectId])
  @@index([userId])
  @@index([employeeId])
}

model ProjectAllocation {
  id                 String           @id @default(cuid())
  projectId          String
  stockItemId        String
  userId             String
  allocatedQuantity  Float
  usedQuantity       Float            @default(0)
  allocatedPrice     Float
  totalAllocatedCost Float
  status             AllocationStatus @default(RESERVED)
  notes              String?
  allocationDate     DateTime         @default(now())
  usageDate          DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  project            Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stockItem          StockItem        @relation(fields: [stockItemId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id])

  @@index([projectId])
  @@index([stockItemId])
  @@index([status])
}

// ============================================
// USER ROLES - Industry standard naming
// ============================================
enum UserRole {
  ORGANIZATION_OWNER // Super admin - created org, full access
  PROCUREMENT_MANAGER // Purchasing - suppliers, purchase orders, stock view
  ACCOUNTANT // Finance - invoices, income/expense, payroll view
  PRODUCTION_MANAGER // Engineering - projects, task assignments, employee work
  HR_MANAGER // Human resources - employees, leave, payroll management
  WAREHOUSE_SUPERVISOR // Inventory - stock in/out, receiving, warehouse ops
  PRODUCTION_SUPERVISOR // Shop floor foreman - assigned projects, task completion
}

enum StockStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
  ARCHIVED
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AllocationStatus {
  RESERVED
  PARTIALLY_USED
  FULLY_USED
  CANCELLED
}

enum TransactionType {
  IN
  OUT
  ADJUST
  RETURN
  TRANSFER
}

enum FieldType {
  text
  number
  textarea
  select
  boolean
  date
  enum
}

enum EntryMode {
  QUICK
  DETAILED
}
