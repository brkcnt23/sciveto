generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATION - Multi-tenant root entity
// ============================================
model Organization {
  id String @id @default(cuid())

  // Identity
  code      String  @unique // ORG-001, ORG-002 (sequential)
  name      String  @unique // Company display name
  legalName String? // Official legal name
  taxId     String? @unique // Tax identification number
  subdomain String  @unique
  domain    String?

  // Subscription & Limits
  plan        SubscriptionPlan @default(BASIC)
  maxUsers    Int              @default(10)
  maxProjects Int              @default(50)

  // Counters (auto-managed)
  userCount     Int @default(1) // Starts at 1 (owner)
  projectCount  Int @default(0)
  employeeCount Int @default(0)

  // Status
  status OrgStatus @default(ACTIVE)

  // Settings
  settings Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  categories Category[]
  projects   Project[]
  items      StockItem[]
  users      User[]
  employees  Employee[]
}

// ============================================
// ENUMS - Organization related
// ============================================
enum SubscriptionPlan {
  TRIAL
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum OrgStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  EXPIRED
}

// ============================================
// USER - System login users (limited per org)
// ============================================
model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String
  firstName String?
  lastName  String?

  // Role & Permissions
  role UserRole @default(ORGANIZATION_OWNER)

  // Profile
  position String? // Job title
  phone    String?
  avatar   String?

  // Status
  isActive    Boolean   @default(true)
  isOnline    Boolean   @default(false)
  lastLoginAt DateTime?

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects           Project[]
  allocations        ProjectAllocation[]
  stockItems         StockItem[]
  projectAssignments ProjectAssignment[]

  @@index([organizationId])
  @@index([role])
  @@index([isActive])
}

// ============================================
// EMPLOYEE - Factory workers (no login, unlimited)
// HR Manager creates these, assigned to projects
// ============================================
model Employee {
  id String @id @default(cuid())

  // Identity
  code      String @unique // EMP-001, EMP-002 (per org sequential)
  firstName String
  lastName  String

  // NO email, NO password - cannot login!

  // Employment
  position        String // "Kaynak Ustası", "Testereci", "Montajcı"
  department      String?
  hireDate        DateTime  @default(now())
  terminationDate DateTime?

  // Payroll
  salary          Decimal?  @db.Decimal(12, 2)
  insuranceStatus Boolean   @default(false)
  insuranceDate   DateTime?

  // Status
  isActive Boolean @default(true)

  // Organization relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projectAssignments ProjectAssignment[]

  @@index([organizationId])
  @@index([code])
  @@index([isActive])
}

model SystemCategoryTemplate {
  id          String             @id @default(cuid())
  name        String
  version     String             @default("1.0")
  isLatest    Boolean            @default(true)
  description String?
  industry    String?
  icon        String?
  changelog   String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  categories  Category[]
  fields      TemplateField[]
  standards   TemplateStandard[]

  @@unique([name, version])
  @@index([name])
  @@index([isLatest])
}

model TemplateStandard {
  id         String                 @id @default(cuid())
  templateId String
  name       String
  value      String
  category   String?
  sortOrder  Int                    @default(0)
  template   SystemCategoryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([category])
}

model TemplateField {
  id           String                 @id @default(cuid())
  templateId   String
  name         String
  label        String
  type         FieldType
  required     Boolean                @default(false)
  defaultValue String?
  options      Json?
  validation   Json?
  unit         String?
  sortOrder    Int                    @default(0)
  template     SystemCategoryTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

model Category {
  id              String                  @id @default(cuid())
  name            String
  description     String?
  color           String                  @default("#3B82F6")
  icon            String?
  organizationId  String
  templateId      String?
  templateVersion String?
  isSystemBased   Boolean                 @default(false)
  customFields    Json?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template        SystemCategoryTemplate? @relation(fields: [templateId], references: [id])
  stockItems      StockItem[]

  @@unique([name, organizationId])
  @@index([organizationId])
  @@index([templateId])
}

model StockItem {
  id                String              @id @default(cuid())
  name              String
  description       String?
  sku               String?             @unique
  barcode           String?             @unique
  unit              String              @default("pcs")
  currentStock      Float               @default(0)
  reservedStock     Float               @default(0)
  availableStock    Float               @default(0)
  minStockLevel     Float               @default(0)
  maxStockLevel     Float?
  // Legacy Fields (Dual-Mode Support)
  shelfCode         String? // Raf No / Kat
  brand             String? // Marka
  color             String? // Renk
  size              String? // Beden
  purchasePrice     Float? // Alış Fiyatı
  salePrice         Float? // Satış Fiyatı 1
  salePrice2        Float? // Satış Fiyatı 2 / Vadeli
  vatRate           Int?                @default(20) // KDV %
  specialCode1      String? // Özel Kod 1
  specialCode2      String? // Özel Kod 2
  // Existing fields
  lastPurchasePrice Float?
  averageCost       Float?
  totalValue        Float               @default(0)
  standardValues    Json?
  customValues      Json?
  specifications    Json?
  organizationId    String
  categoryId        String?
  userId            String
  status            StockStatus         @default(ACTIVE)
  location          String?
  supplier          String?
  notes             String?
  entryMode         EntryMode           @default(DETAILED)
  isComplete        Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  allocations       ProjectAllocation[]
  category          Category?           @relation(fields: [categoryId], references: [id])
  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id])
  transactions      StockTransaction[]

  @@index([organizationId])
  @@index([categoryId])
  @@index([status])
  @@index([isComplete])
  @@index([entryMode])
}

model StockTransaction {
  id            String          @id @default(cuid())
  stockItemId   String
  type          TransactionType
  quantity      Float
  unitPrice     Float?
  totalCost     Float?
  referenceType String?
  referenceId   String?
  description   String?
  performedBy   String?
  supplier      String?
  createdAt     DateTime        @default(now())
  stockItem     StockItem       @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  @@index([stockItemId])
  @@index([type])
  @@index([createdAt])
}

model Project {
  id              String              @id @default(cuid())
  code            String? // PRJ-2026-001 (auto-generated)
  name            String
  description     String?
  projectCode     String? // Legacy field - can be deprecated
  clientName      String?
  location        String?
  startDate       DateTime?
  endDate         DateTime?
  estimatedBudget Float?
  actualCost      Float               @default(0)
  organizationId  String
  managerId       String
  status          ProjectStatus       @default(PLANNING)
  priority        ProjectPriority     @default(MEDIUM)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  manager         User                @relation(fields: [managerId], references: [id])
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  allocations     ProjectAllocation[]
  assignments     ProjectAssignment[]

  @@index([organizationId])
  @@index([status])
  @@index([code])
}

// ============================================
// PROJECT ASSIGNMENT - Links Users OR Employees to Projects
// ============================================
model ProjectAssignment {
  id String @id @default(cuid())

  // Project relation
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Can assign either User OR Employee (not both)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Assignment details
  role  String? // "Lead Welder", "Assistant", "Supervisor"
  notes String?

  // Timestamps
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?

  @@index([projectId])
  @@index([userId])
  @@index([employeeId])
}

model ProjectAllocation {
  id                 String           @id @default(cuid())
  projectId          String
  stockItemId        String
  userId             String
  allocatedQuantity  Float
  usedQuantity       Float            @default(0)
  allocatedPrice     Float
  totalAllocatedCost Float
  status             AllocationStatus @default(RESERVED)
  notes              String?
  allocationDate     DateTime         @default(now())
  usageDate          DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  project            Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stockItem          StockItem        @relation(fields: [stockItemId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id])

  @@index([projectId])
  @@index([stockItemId])
  @@index([status])
}

// ============================================
// USER ROLES - Industry standard naming
// ============================================
enum UserRole {
  ORGANIZATION_OWNER // Super admin - created org, full access
  PROCUREMENT_MANAGER // Purchasing - suppliers, purchase orders, stock view
  ACCOUNTANT // Finance - invoices, income/expense, payroll view
  PRODUCTION_MANAGER // Engineering - projects, task assignments, employee work
  HR_MANAGER // Human resources - employees, leave, payroll management
  WAREHOUSE_SUPERVISOR // Inventory - stock in/out, receiving, warehouse ops
  PRODUCTION_SUPERVISOR // Shop floor foreman - assigned projects, task completion
}

enum StockStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
  ARCHIVED
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AllocationStatus {
  RESERVED
  PARTIALLY_USED
  FULLY_USED
  CANCELLED
}

enum TransactionType {
  PURCHASE
  SALE
  ALLOCATION
  RETURN
  ADJUSTMENT
  TRANSFER
}

enum FieldType {
  text
  number
  textarea
  select
  boolean
  date
  enum
}

enum EntryMode {
  QUICK
  DETAILED
}
